<div class="min-h-screen bg-gray-50">
  <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-6 max-w-7xl overflow-visible">
    <!-- Edit Invoice -->
    <mat-card *ngIf="showEditOption" class="egret-card shadow-lg mx-2 sm:mx-0">
      <mat-card-header class="pb-4">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center w-full">
          <div>
            <mat-card-title class="text-2xl font-bold text-gray-800 mb-2">
              {{invocieId ? 'Edit Invoice' : 'Create New Invoice'}}
            </mat-card-title>
            <!-- PAID Invoice Lock Warning -->
            <div *ngIf="invocieId && invoice?.status === 'PAID'" class="flex items-center space-x-2 bg-green-50 border border-green-300 rounded-lg px-3 py-2 mt-2">
              <mat-icon class="text-green-600 text-sm">lock</mat-icon>
              <span class="text-xs font-semibold text-green-800">This invoice is PAID and locked for editing. View mode only.</span>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
            <button mat-button type="button" *ngIf="!isLoading" 
                    (click)="navigateToInvoices()"
                    class="order-2 sm:order-1">
              <mat-icon class="mr-2">close</mat-icon>
              {{'Cancel' | translate}}
            </button>
            <button-loading [loadingText]="'Saving...'" color="primary" [type]="'submit'"
                            [loading]="isLoading" [disabled]="!canSaveInvoice || invoice?.status === 'PAID'" class="order-1 sm:order-2">
              Save Invoice
            </button-loading>
          </div>

          <div class="mt-3 text-sm text-red-600 font-medium" *ngIf="invoiceForm.get('clientId')?.hasError('required') && invoiceForm.get('clientId')?.touched">
            Client selection is required before creating an invoice.
          </div>
        </div>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="invoiceForm" (ngSubmit)="saveInvoice()" class="space-y-8">
          <!-- Invoice Information Section -->
          <div class="egret-card p-4 sm:p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 sm:mb-6 flex items-center">
              <mat-icon class="mr-3 text-primary-600">receipt</mat-icon>
              Invoice Information
            </h3>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 sm:gap-6">
              <!-- Invoice Number (Read-only for editing) - Rule #6 -->
              <div class="lg:col-span-1" *ngIf="invocieId && invoice?.invoiceNumber">
                <div class="space-y-2">
                  <label class="text-sm font-medium text-gray-700">Invoice Number</label>
                  <div class="flex items-center space-x-2 bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-lg px-4 py-3">
                    <mat-icon class="text-blue-600 text-sm">receipt</mat-icon>
                    <span class="text-base font-bold text-gray-900"># {{invoice.invoiceNumber}}</span>
                    <mat-icon class="text-blue-600 text-sm ml-auto" matTooltip="Invoice number cannot be changed">lock</mat-icon>
                  </div>
                </div>
              </div>
              
              <!-- Invoice Date -->
              <div class="lg:col-span-1">
                <mat-form-field appearance="fill" class="w-full">
                  <mat-label>Invoice Date</mat-label>
                  <input matInput [matDatepicker]="picker" required formControlName="date" />
                  <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                  <mat-datepicker #picker></mat-datepicker>
                </mat-form-field>
              </div>

              <!-- Invoice Status -->
              <div class="lg:col-span-1">
                <div class="space-y-3">
                  <label class="text-sm font-medium text-gray-700">Invoice Status</label>
                  <mat-radio-group formControlName="status" class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0" required>
                    <mat-radio-button value="PENDING" [disabled]="isStatusDisabled('PENDING')" class="flex items-center">
                      <mat-icon class="mr-2 text-yellow-600">schedule</mat-icon>
                      Pending
                    </mat-radio-button>
                    <mat-radio-button value="DEPT" [disabled]="isStatusDisabled('DEPT')" class="flex items-center">
                      <mat-icon class="mr-2 text-orange-600">account_balance_wallet</mat-icon>
                      Dept
                    </mat-radio-button>
                    <mat-radio-button value="PAID" [disabled]="isStatusDisabled('PAID')" class="flex items-center">
                      <mat-icon class="mr-2 text-green-600">check_circle</mat-icon>
                      Paid
                    </mat-radio-button>
                  </mat-radio-group>
                  <!-- Status Transition Info -->
                  <div *ngIf="invocieId && invoice?.status" class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-xs text-blue-800 flex items-center">
                      <mat-icon class="text-blue-600 text-sm mr-1">info</mat-icon>
                      <span *ngIf="invoice.status === 'PENDING'">Can move to: DEPT or PAID</span>
                      <span *ngIf="invoice.status === 'DEPT'">Can move to: PAID only</span>
                      <span *ngIf="invoice.status === 'PAID'">Status locked (invoice is paid)</span>
                    </p>
                  </div>
                </div>
              </div>

              <!-- Deduct from Stock (Only show when creating new invoice) -->
              <div class="lg:col-span-1" *ngIf="!invocieId">
                <div class="space-y-3">
                  <label class="text-sm font-medium text-gray-700">Deduct from Stock</label>
                  <mat-radio-group formControlName="deductFromStock" class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0" required>
                    <mat-radio-button value="Y" class="flex items-center">
                      <mat-icon class="mr-2 text-green-600">done</mat-icon>
                      Yes
                    </mat-radio-button>
                    <mat-radio-button value="N" class="flex items-center">
                      <mat-icon class="mr-2 text-red-600">close</mat-icon>
                      No
                    </mat-radio-button>
                  </mat-radio-group>
                  <div *ngIf="invoiceForm.get('deductFromStock')?.value === 'N'" class="flex items-start space-x-2 bg-amber-50 border border-amber-200 rounded-lg p-3 mt-2">
                    <mat-icon class="text-amber-600 text-sm mt-0.5">info</mat-icon>
                    <p class="text-xs text-amber-800">This invoice will not affect stock levels. It will only impact accounting entries.</p>
                  </div>
                </div>
              </div>

              <!-- Payment Method -->
              <div class="lg:col-span-1">
                <mat-form-field appearance="fill" class="w-full">
                  <mat-label>Payment Method</mat-label>
                  <mat-select formControlName="paymentMethod">
                    <mat-option value="money">Which Money</mat-option>
                    <mat-option value="card">Credit Card</mat-option>
                    <mat-option value="cash">Cash</mat-option>
                  </mat-select>
                  <mat-icon matSuffix>payment</mat-icon>
                </mat-form-field>
              </div>

              <!-- Initial Payment -->
              <div class="lg:col-span-1">
                <mat-form-field appearance="fill" class="w-full">
                  <mat-label>Initial Payment</mat-label>
                  <input matInput type="number" formControlName="initialPayment" min="0" 
                         [max]="calculateSubtotal() - discounts" step="0.01" />
                  <span matPrefix>$ &nbsp;</span>
                  <button mat-stroked-button color="primary" type="button" matSuffix (click)="setMaxInitialPayment()">
                    Max
                  </button>
                  <mat-icon matSuffix>attach_money</mat-icon>
                  <mat-hint *ngIf="(calculateSubtotal() - discounts) > 0">
                    Maximum: ${{(calculateSubtotal() - discounts).toFixed(2)}}
                  </mat-hint>
                  <mat-error *ngIf="invoiceForm.get('initialPayment')?.value > (calculateSubtotal() - discounts)">
                    Payment exceeds invoice total
                  </mat-error>
                </mat-form-field>
              </div>
            </div>
          </div>

          <!-- Client Search Section -->
          <div class="egret-card p-4 sm:p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 sm:mb-6 flex items-center">
              <mat-icon class="mr-3 text-primary-600">person_search</mat-icon>
              Select Client
            </h3>
            
            <!-- Selected Client Display -->
            <div *ngIf="selectedClient" class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-lg shadow-md">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-200 mr-3">
                    <mat-icon class="text-blue-700">person</mat-icon>
                  </div>
                  <div>
                    <p class="text-base font-bold text-gray-900">{{selectedClient.name}}</p>
                    <p class="text-xs text-blue-700 font-medium">Client ID: {{selectedClient.id?.toString().substring(0, 8) || 'N/A'}}</p>
                    <div class="text-xs text-gray-600 mt-1" *ngIf="selectedClient.phone1 || selectedClient.phone2 || selectedClient.phone3">
                      <p *ngIf="selectedClient.phone1">ðŸ“ž {{selectedClient.phone1}}</p>
                      <p *ngIf="selectedClient.phone2">ðŸ“ž {{selectedClient.phone2}}</p>
                      <p *ngIf="selectedClient.phone3">ðŸ“ž {{selectedClient.phone3}}</p>
                    </div>
                    <p class="text-xs text-gray-600" *ngIf="selectedClient.client_type">Type: {{selectedClient.client_type}}</p>
                  </div>
                </div>
                <button mat-icon-button (click)="clearSelectedClient()" type="button" class="text-red-600 hover:bg-red-50">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
            
            <!-- Search Input (only show if no client selected) -->
            <div *ngIf="!selectedClient">
              <mat-form-field appearance="fill" class="w-full">
                <mat-label>Search Client by Name</mat-label>
                <input matInput 
                       [(ngModel)]="clientSearchTerm" 
                       (ngModelChange)="searchClients($event)"
                       [ngModelOptions]="{standalone: true}">
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>

              <!-- Client Selection Dropdown -->
              <mat-form-field appearance="fill" class="w-full" *ngIf="filteredClients.length > 0">
                <mat-label>Select Client</mat-label>
                <mat-select [(ngModel)]="selectedClient" 
                           (selectionChange)="onClientSelected($event.value)"
                           [ngModelOptions]="{standalone: true}">
                  <mat-option *ngFor="let client of filteredClients; trackBy: trackByClientId" [value]="client">
                    <div class="flex items-center justify-between">
                      <div>
                        <span class="font-medium">{{client.name}}</span>
                        <span class="text-gray-500 ml-2" *ngIf="client.phone1">({{client.phone1}})</span>
                      </div>
                      <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">{{client.client_type}}</span>
                    </div>
                  </mat-option>
                </mat-select>
                <mat-icon matSuffix>person</mat-icon>
              </mat-form-field>

              <!-- No Clients Found Message -->
              <div *ngIf="clientSearchTerm && filteredClients.length === 0" class="text-center py-4 text-gray-500">
                <mat-icon class="text-4xl text-gray-300 mb-2">person_remove</mat-icon>
                <p>No clients found matching "{{clientSearchTerm}}"</p>
              </div>
            </div>
          </div>

          <!-- Invoice Items Section -->
          <div class="egret-card p-4 sm:p-6 overflow-visible">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6">
              <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-4 sm:mb-0">
                <mat-icon class="mr-3 text-primary-600">list_alt</mat-icon>
                Invoice Items
              </h3>
              <button mat-raised-button color="primary" type="button" (click)="addNewItem(emptyFormObject)"
                      class="w-full sm:w-auto">
                <mat-icon class="mr-2">add</mat-icon>
                {{'Add Item' | translate}}
              </button>
            </div>

            <!-- Items Table -->
            <div formArrayName="item" class="bg-white border border-gray-200 rounded-lg overflow-visible">
              <!-- Table Header (Desktop) -->
              <div class="hidden md:grid md:grid-cols-7 bg-gray-50 border-b border-gray-200">
                <div class="px-3 py-2 text-xs font-semibold text-gray-600 text-center">#</div>
                <div class="px-3 py-2 text-xs font-semibold text-gray-600">{{'Item Code' | translate}}</div>
                <div class="px-3 py-2 text-xs font-semibold text-gray-600 text-center">{{'Unit Price' | translate}}</div>
                <div class="px-3 py-2 text-xs font-semibold text-gray-600 text-center">{{'Quantity' | translate}}</div>
                <div class="px-3 py-2 text-xs font-semibold text-gray-600 text-center">{{'Is Free' | translate}}</div>
                <div class="px-3 py-2 text-xs font-semibold text-gray-600 text-center">{{'Total' | translate}}</div>
                <div class="px-3 py-2 text-xs font-semibold text-gray-600 text-center">{{'Actions' | translate}}</div>
              </div>

              <!-- Items List -->
              <div *ngFor="let item of invoiceItemFormArray.controls; let i = index" 
                   [formGroup]="item" 
                   class="border-b border-gray-100 last:border-b-0 hover:bg-gray-50 transition-colors">
                
                <!-- Mobile Layout -->
                <div class="md:hidden p-3 sm:p-4 space-y-3">
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-700">{{'Item' | translate}} {{ i + 1 }}</span>
                    <button mat-icon-button color="warn" type="button" (click)="deleteItemFromInvoice(i)" 
                            size="small" class="h-8 w-8">
                      <mat-icon class="text-sm">delete</mat-icon>
                    </button>
                  </div>
                  
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <mat-form-field appearance="fill" class="w-full">
                      <mat-label class="text-xs">{{'Item Code' | translate}}</mat-label>
                      <input formControlName="code" 
                             matInput 
                             required 
                             readonly
                             class="text-xs cursor-pointer"
                             (click)="openItemSelectionModal(i)">
                      <mat-icon matSuffix class="text-xs cursor-pointer" (click)="openItemSelectionModal(i)">inventory</mat-icon>
                    </mat-form-field>
                    
                    <mat-form-field appearance="fill" class="w-full">
                      <mat-label class="text-xs">{{'Unit Price' | translate}}</mat-label>
                      <input type="number" formControlName="price" matInput required class="text-xs" />
                      <span matPrefix class="text-xs">$&nbsp;</span>
                    </mat-form-field>
                  </div>
                  
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <mat-form-field appearance="fill" class="w-full">
                      <mat-label class="text-xs">{{'Quantity' | translate}}</mat-label>
                      <input
                        type="number"
                        formControlName="unit"
                        matInput
                        required
                        class="text-xs"
                        min="1"
                        (input)="onQuantityChange(i)"
                        [attr.max]="getQuantityMax(i) ?? null" />
                      <mat-hint *ngIf="invoiceForm.get('deductFromStock')?.value === 'Y' && getQuantityMax(i) !== null">
                        Available: {{ getQuantityMax(i) }} units
                      </mat-hint>
                      <mat-error *ngIf="item.get('unit')?.hasError('exceedsStock') && item.get('unit')?.touched">
                        Quantity cannot exceed available stock ({{ item.get('unit')?.errors?.['exceedsStock']?.available }})
                      </mat-error>
                    </mat-form-field>
                    
                    <div class="flex items-center justify-center sm:justify-start">
                      <mat-checkbox formControlName="isFree" class="text-xs">
                        <span class="text-xs">{{'Free' | translate}}</span>
                      </mat-checkbox>
                    </div>
                  </div>
                  
                  <div class="flex justify-between items-center pt-2">
                    <span class="text-sm font-medium text-gray-600">{{'Total' | translate}}:</span>
                    <span class="text-sm font-bold text-blue-600">${{ calculateItemTotal(item) }}</span>
                  </div>
                </div>

                <!-- Desktop Layout -->
                <div class="hidden md:grid md:grid-cols-7 items-center min-h-[48px]">
                  <!-- Row Number -->
                  <div class="px-3 py-2 text-center">
                    <span class="text-xs font-medium text-gray-500 bg-gray-100 rounded-full w-6 h-6 flex items-center justify-center mx-auto">{{ i + 1 }}</span>
                  </div>
                  
                  <!-- Item Code -->
                  <div class="px-3 py-2">
                    <mat-form-field appearance="fill" class="w-full">
                      <mat-label class="text-xs">Item Code</mat-label>
                      <input formControlName="code" 
                             matInput 
                             required 
                             readonly
                             class="text-xs cursor-pointer"
                             (click)="openItemSelectionModal(i)">
                      <mat-icon matSuffix class="text-xs text-gray-400 cursor-pointer" (click)="openItemSelectionModal(i)">search</mat-icon>
                    </mat-form-field>
                  </div>
                  
                  <!-- Unit Price -->
                  <div class="px-3 py-2">
                    <mat-form-field appearance="fill" class="w-full">
                      <input type="number" formControlName="price" matInput required class="text-xs text-center" step="0.01" min="0" />
                      <span matPrefix class="text-xs text-gray-500">$&nbsp;</span>
                    </mat-form-field>
                  </div>
                  
                  <!-- Quantity -->
                  <div class="px-3 py-2">
                    <mat-form-field appearance="fill" class="w-full">
                      <input
                        type="number"
                        formControlName="unit"
                        matInput
                        required
                        class="text-xs text-center"
                        min="1"
                        (input)="onQuantityChange(i)"
                        [attr.max]="getQuantityMax(i) ?? null" />
                      <mat-hint *ngIf="invoiceForm.get('deductFromStock')?.value === 'Y' && getQuantityMax(i) !== null">
                        Available: {{ getQuantityMax(i) }} units
                      </mat-hint>
                      <mat-error *ngIf="item.get('unit')?.hasError('exceedsStock') && item.get('unit')?.touched">
                        Quantity cannot exceed available stock ({{ item.get('unit')?.errors?.['exceedsStock']?.available }})
                      </mat-error>
                    </mat-form-field>
                  </div>
                  
                  <!-- Is Free -->
                  <div class="px-3 py-2 text-center">
                    <mat-checkbox formControlName="isFree" class="text-xs">
                      <span class="text-xs">{{'Free' | translate}}</span>
                    </mat-checkbox>
                  </div>
                  
                  <!-- Total -->
                  <div class="px-3 py-2 text-center">
                    <span class="text-xs font-medium text-gray-700">${{ calculateItemTotal(item) }}</span>
                  </div>
                  
                  <!-- Actions -->
                  <div class="px-3 py-2 text-center">
                    <button mat-icon-button color="warn" type="button" (click)="deleteItemFromInvoice(i)"
                            size="small" class="h-8 w-8">
                      <mat-icon class="text-sm">delete</mat-icon>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Empty State -->
              <div *ngIf="invoiceItemFormArray.length === 0" 
                   class="text-center py-12 text-gray-500">
                <mat-icon class="text-6xl text-gray-300 mb-4">inventory_2</mat-icon>
                <h4 class="text-lg font-medium text-gray-700 mb-2">{{'No items added yet' | translate}}</h4>
                <p class="text-gray-500 mb-4">{{'Click "Add Item" to start building your invoice' | translate}}</p>
                <button mat-raised-button color="primary" type="button" (click)="addNewItem(emptyFormObject)">
                  <mat-icon class="mr-2">add</mat-icon>
                  {{'Add Your First Item' | translate}}
                </button>
              </div>
            </div>
          </div>

          <!-- Invoice Summary Section -->
          <div class="egret-card p-4 sm:p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 sm:mb-6 flex items-center">
              <mat-icon class="mr-3 text-primary-600">calculate</mat-icon>
              Invoice Summary
            </h3>
            
            <!-- Summary Overview Cards -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6">
              <!-- Items Count -->
              <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-3 sm:p-4 border border-blue-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs sm:text-sm font-medium text-blue-600 mb-1">Total Items</p>
                    <p class="text-lg sm:text-2xl font-bold text-blue-800">{{invoiceItemFormArray.length}}</p>
                  </div>
                  <mat-icon class="text-blue-500 text-lg sm:text-2xl">inventory</mat-icon>
                </div>
              </div>

              <!-- Subtotal -->
              <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-3 sm:p-4 border border-green-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs sm:text-sm font-medium text-green-600 mb-1">Subtotal</p>
                    <p class="text-lg sm:text-xl font-bold text-green-800">${{calculateSubtotal().toFixed(2)}}</p>
                  </div>
                  <mat-icon class="text-green-500 text-lg sm:text-2xl">attach_money</mat-icon>
                </div>
              </div>

              <!-- Discount -->
              <div *ngIf="discounts > 0" class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-3 sm:p-4 border border-orange-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs sm:text-sm font-medium text-orange-600 mb-1">Discount</p>
                    <p class="text-lg sm:text-xl font-bold text-orange-800">-${{discounts.toFixed(2)}}</p>
                  </div>
                  <mat-icon class="text-orange-500 text-lg sm:text-2xl">local_offer</mat-icon>
                </div>
              </div>

              <!-- Total Amount -->
              <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-3 sm:p-4 border border-gray-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs sm:text-sm font-medium text-gray-600 mb-1">Total Amount</p>
                    <p class="text-lg sm:text-xl font-bold text-gray-800">${{(calculateSubtotal() - discounts).toFixed(2)}}</p>
                  </div>
                  <mat-icon class="text-gray-500 text-lg sm:text-2xl">calculate</mat-icon>
                </div>
              </div>
              
              <!-- Initial Payment -->
              <div *ngIf="(invoiceForm.get('initialPayment')?.value || 0) > 0" class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-3 sm:p-4 border border-blue-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs sm:text-sm font-medium text-blue-600 mb-1">Amount Settled</p>
                    <p class="text-lg sm:text-xl font-bold text-blue-800">${{(invoiceForm.get('initialPayment')?.value || 0).toFixed(2)}}</p>
                  </div>
                  <mat-icon class="text-blue-500 text-lg sm:text-2xl">account_balance_wallet</mat-icon>
                </div>
              </div>
              
              <!-- Grand Total (Remaining Balance) -->
              <div class="bg-gradient-to-br from-primary-50 to-primary-100 rounded-xl p-3 sm:p-4 border border-primary-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs sm:text-sm font-medium text-primary-600 mb-1">Remaining Balance</p>
                    <p class="text-lg sm:text-xl font-bold text-primary-800">${{(calculateSubtotal() - discounts - (invoiceForm.get('initialPayment')?.value || 0)).toFixed(2)}}</p>
                  </div>
                  <mat-icon class="text-primary-500 text-lg sm:text-2xl">payments</mat-icon>
                </div>
              </div>
            </div>

            <!-- Configuration Section -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
              <!-- VAT Configuration -->
              <div class="bg-gray-50 rounded-lg p-3 sm:p-4">
                <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                  <mat-icon class="mr-2 text-purple-600 text-sm">settings</mat-icon>
                  Tax Configuration
                </h4>
                <mat-form-field appearance="fill" class="w-full">
                  <mat-label>VAT Percentage (%)</mat-label>
                  <input type="number" formControlName="vat" matInput required min="0" max="100" step="0.1" />
                  <mat-hint class="text-xs">For reference only - not applied to total</mat-hint>
                </mat-form-field>
              </div>

              <!-- Discount Configuration -->
              <div class="bg-gray-50 rounded-lg p-3 sm:p-4">
                <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                  <mat-icon class="mr-2 text-orange-600 text-sm">settings</mat-icon>
                  Discount Configuration
                </h4>
                <mat-form-field appearance="fill" class="w-full">
                  <mat-label>Discount Amount ($)</mat-label>
                  <input type="number" formControlName="discounts" matInput step="0.01" min="0" />
                </mat-form-field>
              </div>
            </div>

            <!-- Detailed Breakdown -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-6 border border-gray-200">
              <h4 class="text-sm font-semibold text-gray-700 mb-4 flex items-center">
                <mat-icon class="mr-2 text-gray-600 text-sm">receipt_long</mat-icon>
                Detailed Breakdown
              </h4>
              
                <div class="space-y-3">
                <!-- Subtotal Row -->
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                  <div class="flex items-center">
                    <mat-icon class="mr-2 text-green-600 text-sm">check_circle</mat-icon>
                    <span class="text-sm font-medium text-gray-700">Subtotal ({{invoiceItemFormArray.length}} items)</span>
                  </div>
                  <span class="text-sm font-semibold text-gray-800">${{calculateSubtotal().toFixed(2)}}</span>
                </div>

                <!-- Discount Row -->
                <div class="flex justify-between items-center py-2 border-b border-gray-200" *ngIf="discounts > 0">
                  <div class="flex items-center">
                    <mat-icon class="mr-2 text-orange-600 text-sm">local_offer</mat-icon>
                    <span class="text-sm font-medium text-gray-700">Discount</span>
                  </div>
                  <span class="text-sm font-semibold text-red-600">-${{discounts.toFixed(2)}}</span>
                </div>

                <!-- Total Amount Row -->
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                  <div class="flex items-center">
                    <mat-icon class="mr-2 text-gray-600 text-sm">calculate</mat-icon>
                    <span class="text-sm font-medium text-gray-700">Total Amount</span>
                  </div>
                  <span class="text-sm font-semibold text-gray-800">${{(calculateSubtotal() - discounts).toFixed(2)}}</span>
                </div>

                <!-- Amount Settled Row -->
                <div class="flex justify-between items-center py-2 border-b border-gray-200" *ngIf="(invoiceForm.get('initialPayment')?.value || 0) > 0">
                  <div class="flex items-center">
                    <mat-icon class="mr-2 text-blue-600 text-sm">account_balance_wallet</mat-icon>
                    <span class="text-sm font-medium text-gray-700">Amount Settled (Initial Payment)</span>
                  </div>
                  <span class="text-sm font-semibold text-blue-600">-${{(invoiceForm.get('initialPayment')?.value || 0).toFixed(2)}}</span>
                </div>

                <!-- Grand Total (Remaining Balance) Row -->
                <div class="flex justify-between items-center py-3 bg-white rounded-lg px-4 mt-4 border-2 border-primary-200">
                  <div class="flex items-center">
                    <mat-icon class="mr-2 text-primary-600">payments</mat-icon>
                    <span class="text-base font-bold text-gray-800">Grand Total (Remaining)</span>
                  </div>
                  <span class="text-2xl font-bold text-primary-600">${{(calculateSubtotal() - discounts - (invoiceForm.get('initialPayment')?.value || 0)).toFixed(2)}}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-end pt-4 sm:pt-6 border-t border-gray-200">
            <!-- Validation Message -->
            <div *ngIf="!canSaveInvoice && invoiceItemFormArray.length === 0" class="flex-1 flex items-center text-amber-600 text-sm">
              <mat-icon class="mr-2 text-base">info</mat-icon>
              <span>Please add at least one item to create the invoice</span>
            </div>
            
            <button mat-button type="button" *ngIf="!isLoading" 
                    (click)="navigateToInvoices()"
                    class="order-2 sm:order-1 w-full sm:w-auto">
              <mat-icon class="mr-2">close</mat-icon>
              {{'Cancel' | translate}}
            </button>
            <button-loading [loadingText]="'Saving...'" color="primary" [type]="'submit'"
                            [loading]="isLoading" [disabled]="!canSaveInvoice" class="order-1 sm:order-2 w-full sm:w-auto">
              {{invocieId ? 'Update Invoice' : 'Create Invoice'}}
            </button-loading>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Invoice Details View -->
    <mat-card *ngIf="!showEditOption" class="egret-card shadow-lg">
      <mat-card-header class="pb-4">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center w-full">
          <button mat-button routerLink="/invoice/invoices" class="mb-4 sm:mb-0">
            <mat-icon class="mr-2">arrow_back</mat-icon>
            {{'Back to Invoices' | translate}}
          </button>
          <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
            <button mat-raised-button color="primary" (click)="showEditOption = !showEditOption"
                    class="order-2 sm:order-1">
              <mat-icon class="mr-2">edit</mat-icon>
              Edit Invoice
            </button>
            <button mat-raised-button color="accent" (click)="print()" class="order-1 sm:order-2">
              <mat-icon class="mr-2">print</mat-icon>
              Print Invoice
            </button>
          </div>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div id="print-area" class="space-y-8">
          <!-- Invoice Information -->
          <div class="egret-card p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
              <mat-icon class="mr-3 text-primary-600">receipt</mat-icon>
              Invoice Information
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <div class="space-y-2">
                <p class="text-sm text-gray-600">Invoice Number</p>
                <p class="text-lg font-semibold text-gray-800"># {{ invoice?.invoiceNumber || invoice?.orderNo }}</p>
              </div>

              <div class="space-y-2">
                <p class="text-sm text-gray-600">Client Name</p>
                <p class="text-lg font-semibold text-gray-800">{{ invoice?.clientName || 'N/A' }}</p>
              </div>
              
              <div class="space-y-2">
                <p class="text-sm text-gray-600">Invoice Status</p>
                <mat-chip [color]="getStatusColor(invoice?.status)" [selected]="true">
                  {{ invoice?.status | titlecase }}
                </mat-chip>
              </div>
              
              <div class="space-y-2">
                <p class="text-sm text-gray-600">Invoice Date</p>
                <p class="text-lg font-semibold text-gray-800">{{ invoice?.date | date:'fullDate' }}</p>
              </div>

              <div class="space-y-2">
                <p class="text-sm text-gray-600">Deduct from Stock</p>
                <div class="flex items-center">
                  <mat-icon class="mr-2" [class.text-green-600]="invoice?.deductFromStock === 'Y'" [class.text-red-600]="invoice?.deductFromStock === 'N'">
                    {{ invoice?.deductFromStock === 'Y' ? 'check_circle' : 'cancel' }}
                  </mat-icon>
                  <span class="text-lg font-semibold text-gray-800">{{ invoice?.deductFromStock === 'Y' ? 'Yes' : 'No' }}</span>
                </div>
              </div>

              <div class="space-y-2" *ngIf="invoice?.paymentMethod">
                <p class="text-sm text-gray-600">Payment Method</p>
                <div class="flex items-center">
                  <mat-icon class="mr-2 text-primary-600">payment</mat-icon>
                  <span class="text-lg font-semibold text-gray-800">
                    {{ invoice?.paymentMethod === 'money' ? 'Which Money' : 
                       invoice?.paymentMethod === 'card' ? 'Credit Card' : 
                       invoice?.paymentMethod === 'cash' ? 'Cash' : 
                       invoice?.paymentMethod }}
                  </span>
                </div>
              </div>
            </div>
          </div>


          <!-- Invoice Items -->
          <div class="egret-card p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
              <mat-icon class="mr-3 text-primary-600">list_alt</mat-icon>
              Invoice Items
            </h3>
            
            <!-- Desktop Table -->
            <div class="hidden md:block overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b border-gray-200">
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">#</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Item Name</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Unit Price</th>
                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Quantity</th>
                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Total</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of invoice.item; let i = index" class="border-b border-gray-100">
                    <td class="py-3 px-4 text-gray-600">{{ i + 1 }}</td>
                    <td class="py-3 px-4 font-medium text-gray-800">{{ item.name }}</td>
                    <td class="py-3 px-4 text-gray-600">${{ item.price }}</td>
                    <td class="py-3 px-4 text-gray-600">{{ item.unit }}</td>
                    <td class="py-3 px-4 text-right font-semibold text-primary-600">${{ item.unit * item.price }}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Mobile Cards -->
            <div class="md:hidden space-y-4">
              <div *ngFor="let item of invoice.item; let i = index" class="egret-card p-4">
                <div class="flex justify-between items-start mb-3">
                  <span class="font-medium text-gray-600">Item {{ i + 1 }}</span>
                  <span class="text-sm text-gray-500">${{ item.unit * item.price }}</span>
                </div>
                <h4 class="font-semibold text-gray-800 mb-2">{{ item.name }}</h4>
                <div class="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span class="text-gray-600">Unit Price:</span>
                    <span class="font-medium ml-2">${{ item.price }}</span>
                  </div>
                  <div>
                    <span class="text-gray-600">Quantity:</span>
                    <span class="font-medium ml-2">{{ item.unit }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Invoice Summary -->
          <div class="egret-card p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
              <mat-icon class="mr-3 text-primary-600">calculate</mat-icon>
              Invoice Summary
            </h3>
            
            <!-- Summary Overview Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <!-- Items Count -->
              <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border border-blue-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-blue-600 mb-1">Total Items</p>
                    <p class="text-2xl font-bold text-blue-800">{{invoice.item?.length || 0}}</p>
                  </div>
                  <mat-icon class="text-blue-500 text-2xl">inventory</mat-icon>
                </div>
              </div>

              <!-- Subtotal -->
              <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border border-green-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-green-600 mb-1">Subtotal</p>
                    <p class="text-xl font-bold text-green-800">${{cost.toFixed(2)}}</p>
                  </div>
                  <mat-icon class="text-green-500 text-2xl">attach_money</mat-icon>
                </div>
              </div>

              <!-- Discount -->
              <div *ngIf="(invoice?.discountAmount || invoice?.discounts || 0) > 0" class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-4 border border-orange-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-orange-600 mb-1">Discount</p>
                    <p class="text-xl font-bold text-orange-800">-${{(invoice?.discountAmount || invoice?.discounts || 0).toFixed(2)}}</p>
                  </div>
                  <mat-icon class="text-orange-500 text-2xl">local_offer</mat-icon>
                </div>
              </div>

              <!-- Free Items -->
              <div *ngIf="getFreeItemsValue() > 0" class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border border-green-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-green-600 mb-1">Free Items</p>
                    <p class="text-xl font-bold text-green-800">${{getFreeItemsValue().toFixed(2)}}</p>
                  </div>
                  <mat-icon class="text-green-500 text-2xl">card_giftcard</mat-icon>
                </div>
              </div>

              <!-- Amount Settled -->
              <div *ngIf="(invoice?.amountSettled || 0) > 0" class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border border-blue-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-blue-600 mb-1">Amount Settled</p>
                    <p class="text-xl font-bold text-blue-800">${{(invoice?.amountSettled || 0).toFixed(2)}}</p>
                  </div>
                  <mat-icon class="text-blue-500 text-2xl">account_balance_wallet</mat-icon>
                </div>
              </div>

              <!-- Grand Total (Remaining) -->
              <div class="bg-gradient-to-br from-primary-50 to-primary-100 rounded-xl p-4 border border-primary-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-primary-600 mb-1">Grand Total</p>
                    <p class="text-xl font-bold text-primary-800">${{(invoice?.remainingAmount || invoice?.totalAmount || 0).toFixed(2)}}</p>
                  </div>
                  <mat-icon class="text-primary-500 text-2xl">payments</mat-icon>
                </div>
              </div>
            </div>

            <!-- Detailed Breakdown -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-6 border border-gray-200">
              <h4 class="text-sm font-semibold text-gray-700 mb-4 flex items-center">
                <mat-icon class="mr-2 text-gray-600 text-sm">receipt_long</mat-icon>
                Detailed Breakdown
              </h4>
              
              <div class="space-y-3">
                <!-- Subtotal Row -->
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                  <div class="flex items-center">
                    <mat-icon class="mr-2 text-green-600 text-sm">check_circle</mat-icon>
                    <span class="text-sm font-medium text-gray-700">Subtotal ({{invoice.item?.length || 0}} items)</span>
                  </div>
                  <span class="text-sm font-semibold text-gray-800">${{(invoice?.totalAmountBeforeDiscount || cost).toFixed(2)}}</span>
                </div>

                <!-- Free Items Row -->
                <div class="flex justify-between items-center py-2 border-b border-gray-200" *ngIf="getFreeItemsValue() > 0">
                  <div class="flex items-center">
                    <mat-icon class="mr-2 text-green-600 text-sm">card_giftcard</mat-icon>
                    <span class="text-sm font-medium text-gray-700">Free Items</span>
                  </div>
                  <span class="text-sm font-semibold text-green-600">${{getFreeItemsValue().toFixed(2)}}</span>
                </div>

                <!-- Discount Row -->
                <div class="flex justify-between items-center py-2 border-b border-gray-200" *ngIf="(invoice?.discountAmount || invoice?.discounts || 0) > 0">
                  <div class="flex items-center">
                    <mat-icon class="mr-2 text-orange-600 text-sm">local_offer</mat-icon>
                    <span class="text-sm font-medium text-gray-700">Discount</span>
                  </div>
                  <span class="text-sm font-semibold text-red-600">-${{(invoice?.discountAmount || invoice?.discounts || 0).toFixed(2)}}</span>
                </div>

                <!-- Total Amount (after discount) Row -->
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                  <div class="flex items-center">
                    <mat-icon class="mr-2 text-gray-600 text-sm">calculate</mat-icon>
                    <span class="text-sm font-medium text-gray-700">Total Amount</span>
                  </div>
                  <span class="text-sm font-semibold text-gray-800">${{(invoice?.totalAmount || 0).toFixed(2)}}</span>
                </div>

                <!-- Amount Settled Row -->
                <div class="flex justify-between items-center py-2 border-b border-gray-200" *ngIf="(invoice?.amountSettled || 0) > 0">
                  <div class="flex items-center">
                    <mat-icon class="mr-2 text-blue-600 text-sm">account_balance_wallet</mat-icon>
                    <span class="text-sm font-medium text-gray-700">Amount Settled (Initial Payment)</span>
                  </div>
                  <span class="text-sm font-semibold text-blue-600">-${{(invoice?.amountSettled || 0).toFixed(2)}}</span>
                </div>

                <!-- Grand Total (Remaining Balance) Row -->
                <div class="flex justify-between items-center py-3 bg-white rounded-lg px-4 mt-4 border-2 border-primary-200">
                  <div class="flex items-center">
                    <mat-icon class="mr-2 text-primary-600">payments</mat-icon>
                    <span class="text-base font-bold text-gray-800">Grand Total (Remaining)</span>
                  </div>
                  <span class="text-2xl font-bold text-primary-600">${{(invoice?.remainingAmount || invoice?.totalAmount || 0).toFixed(2)}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Item Selection Modal -->
  <div *ngIf="showItemSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000] p-2 sm:p-4" (click)="closeItemSelectionModal()">
    <div class="bg-white rounded-lg shadow-2xl max-w-6xl w-full h-[95vh] flex flex-col modal-content-area" (click)="$event.stopPropagation()">
      
      <!-- Modal Header -->
      <div class="text-white p-4 sm:p-6 flex-shrink-0" style="background: linear-gradient(to right, #0f174c, #1a2b5c);">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <mat-icon class="mr-2 sm:mr-3 text-xl sm:text-2xl">inventory_2</mat-icon>
            <div>
              <h2 class="text-lg sm:text-xl font-bold">Select Item</h2>
              <p class="text-white text-xs sm:text-sm opacity-90 hidden sm:block">Search and select an item for your invoice</p>
            </div>
          </div>
          <button mat-icon-button (click)="closeItemSelectionModal()" class="text-white hover:bg-[#1a2b5c]">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>

      <!-- Modal Content -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Search Section -->
        <div class="px-4 sm:px-6 pt-4 sm:pt-6 pb-2 flex-shrink-0">
          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Search by Item Name or Code</mat-label>
            <input matInput 
                   [(ngModel)]="modalSearchTerm" 
                   (ngModelChange)="searchItemsInModal($event)"
                   [ngModelOptions]="{standalone: true}">
            <mat-icon matSuffix>search</mat-icon>
            <mat-hint>Search updates automatically as you type</mat-hint>
          </mat-form-field>
        </div>

        <!-- Items Section -->
        <div class="flex-1 px-4 sm:px-6 pb-4 overflow-y-auto">
          <div class="flex items-center justify-between mb-3 sm:mb-4">
            <h3 class="text-base sm:text-lg font-semibold text-gray-800">Available Items</h3>
            <span class="text-xs sm:text-sm text-gray-500">
              {{filteredModalItems.length}} 
              <span *ngIf="totalItems > filteredModalItems.length">of {{totalItems}}</span> 
              items
            </span>
          </div>

          <!-- Loading Initial Items -->
          <div *ngIf="isLoadingItems && filteredModalItems.length === 0" class="py-16 text-center text-gray-500">
            <mat-spinner diameter="40" class="mx-auto mb-3"></mat-spinner>
            <p class="text-lg font-medium">Loading items...</p>
          </div>

          <!-- No Items Found -->
          <div *ngIf="!isLoadingItems && filteredModalItems.length === 0" class="py-16 text-center text-gray-500">
            <mat-icon class="text-6xl text-gray-300 mb-3">search_off</mat-icon>
            <p class="text-lg font-medium">No items found</p>
            <p class="text-sm">Try adjusting your search terms</p>
          </div>

          <!-- Items Grid -->
          <div *ngIf="filteredModalItems.length > 0">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4 mb-4">
              <div *ngFor="let item of filteredModalItems; trackBy: trackByItemId" 
                   class="bg-white border border-gray-200 rounded-lg p-3 hover:shadow-lg hover:border-blue-400 cursor-pointer transition-all duration-200"
                   (click)="selectItemFromModal(item)">
                
                <!-- Item Header -->
                <div class="flex items-start justify-between mb-2">
                  <div class="flex-1 min-w-0 pr-2">
                    <h4 class="font-semibold text-gray-900 text-sm truncate">{{item.name}}</h4>
                    <p class="text-xs text-gray-500 font-mono bg-gray-100 px-2 py-0.5 rounded mt-1 inline-block">{{item.code}}</p>
                  </div>
                  <div class="flex-shrink-0">
                    <div class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded-full">
                      ${{item.final_price}}
                    </div>
                  </div>
                </div>

                <!-- Item Details with Enhanced Stock Info (Rule 3.2) -->
                <div class="space-y-2 mb-3">
                  <!-- Available Stock -->
                  <div class="flex items-center justify-between text-xs">
                    <div class="flex items-center" 
                         [class]="(item.total_quantity || 0) === 0 ? 'text-red-600 font-bold' : 
                                  (item.total_quantity || 0) <= (item.min_stock || 0) ? 'text-orange-600 font-bold' : 'text-green-600 font-semibold'">
                      <mat-icon class="text-base mr-1">inventory</mat-icon>
                      <span>Available: {{item.total_quantity || 0}} units</span>
                    </div>
                  </div>
                  
                  <!-- Min Stock -->
                  <div class="flex items-center justify-between text-xs text-gray-600">
                    <div class="flex items-center">
                      <mat-icon class="text-base mr-1">warning</mat-icon>
                      <span>Min Stock: {{item.min_stock || 0}} units</span>
                    </div>
                  </div>
                  
                  <!-- Type -->
                  <div class="flex items-center text-xs text-gray-600" *ngIf="item.type">
                    <mat-icon class="text-base mr-1">category</mat-icon>
                    <span class="truncate">{{item.type}}</span>
                  </div>
                  
                  <!-- Status Badge -->
                  <div class="flex items-center justify-center mt-1">
                    <span class="text-xs font-bold px-3 py-1 rounded-full" [ngClass]="{
                      'bg-green-100 text-green-800 border border-green-300': (item.total_quantity || 0) > (item.min_stock || 0),
                      'bg-orange-100 text-orange-800 border border-orange-300': (item.total_quantity || 0) <= (item.min_stock || 0) && (item.total_quantity || 0) > 0,
                      'bg-red-100 text-red-800 border border-red-300': (item.total_quantity || 0) <= 0
                    }">
                      <mat-icon class="text-xs align-middle mr-1">
                        {{(item.total_quantity || 0) > (item.min_stock || 0) ? 'check_circle' : (item.total_quantity || 0) > 0 ? 'warning' : 'cancel'}}
                      </mat-icon>
                      {{(item.total_quantity || 0) > (item.min_stock || 0) ? 'IN STOCK' : (item.total_quantity || 0) > 0 ? 'LOW STOCK' : 'OUT OF STOCK'}}
                    </span>
                  </div>
                </div>

                <!-- Selection Button -->
                <button mat-stroked-button color="primary" class="w-full text-xs py-1">
                  <mat-icon class="mr-1 text-sm">add</mat-icon>
                  Select
                </button>
              </div>
            </div>

            <!-- Load More Button -->
            <div *ngIf="hasMoreItems" class="flex justify-center py-4 border-t border-gray-200">
              <button mat-raised-button color="accent" (click)="loadMoreItems()" [disabled]="isLoadingItems" class="px-8">
                <mat-icon class="mr-2" *ngIf="!isLoadingItems">expand_more</mat-icon>
                <mat-spinner diameter="20" class="mr-2" *ngIf="isLoadingItems"></mat-spinner>
                {{isLoadingItems ? 'Loading...' : 'Load More Items'}}
              </button>
            </div>

            <!-- End of Results -->
            <div *ngIf="!hasMoreItems && filteredModalItems.length > 0" class="text-center py-3 border-t border-gray-200 text-gray-500 text-sm">
              <mat-icon class="text-base align-middle mr-1">check_circle</mat-icon>
              <span class="align-middle">All items loaded</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="bg-gray-50 px-4 sm:px-6 py-3 sm:py-4 flex justify-end flex-shrink-0 border-t border-gray-200">
        <button mat-button (click)="closeItemSelectionModal()" class="w-full sm:w-auto">
          <mat-icon class="mr-2">close</mat-icon>
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>